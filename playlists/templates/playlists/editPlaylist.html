{% extends "_base.html" %}
{% block title %}Edit Playlist › Muzikos sistema{% endblock %}

{% block content %}
<style>
  .draggable-item {
    cursor: grab;
    user-select: none;
  }
  .drag-over {
    border: 2px dashed #0d6efd;
  }
</style>

<div class="d-flex justify-content-between align-items-start mb-4">
  <h2 class="fw-semibold mb-0">Redaguoti grojaraštį</h2>
</div>

{% if success_message %}
<div class="alert alert-success" role="alert">
  {{ success_message }}
</div>
{% endif %}

{% if errors %}
<div class="alert alert-danger" role="alert">
  <ul class="mb-0">
    {% for error in errors %}
      <li>{{ error }}</li>
    {% endfor %}
  </ul>
</div>
{% endif %}

<div class="card bg-body-tertiary shadow-sm">
  <div class="card-body">
    <form method="POST">
      {% csrf_token %}

      <div class="mb-3">
        <label class="form-label">Pavadinimas</label>
        <input
          type="text"
          name="pavadinimas"
          class="form-control"
          value="{{ grojarastis.pavadinimas }}"
          required
        >
      </div>

      <div class="mb-3">
        <label class="form-label">Aprašymas</label>
        <textarea
          name="aprasymas"
          rows="3"
          class="form-control"
        >{{ grojarastis.aprasymas }}</textarea>
      </div>

      <div class="mb-3">
        <label class="form-label">Matomumas</label>
        <select name="yra_viesas" class="form-select">
          <option value="on" {% if grojarastis.yra_viesas %}selected{% endif %}>Public</option>
          <option value="off" {% if not grojarastis.yra_viesas %}selected{% endif %}>Private</option>
        </select>
      </div>

      <hr class="my-4">

      <h5>Dainų eiliškumas</h5>
      {% if grojarastis.dainos.all %}
        <p class="text-secondary">Nutempk dainą į norima vieta saraše.</p>

        <ul id="song-list" class="list-group mb-4">
          {% for entry in grojarastis.dainos.all %}
          <li
            class="list-group-item bg-dark text-white draggable-item"
            draggable="true"
            data-id="{{ entry.id }}"
          >
            <strong>{{ entry.daina.pavadinimas }}</strong>
            <span class="text-secondary">— {{ entry.daina.atlikejas }}</span>
          </li>
          {% endfor %}
        </ul>
      {% else %}
        <p class="text-secondary">Grojaraštis neturi dainų.</p>
      {% endif %}

      <input type="hidden" name="sorted_order" id="sorted_order">

      <div class="d-flex gap-2">
        <button type="submit" class="btn btn-success">
          Įšsaugoti
        </button>
        <a href="{% url 'playlists:PlaylistDetail' grojarastis.pk %}" class="btn btn-secondary">
          Atšaukti
        </a>
      </div>
    </form>
  </div>
</div>

<script>
let dragging = null;

document.querySelectorAll(".draggable-item").forEach(item => {
  item.addEventListener("dragstart", () => {
    dragging = item;
    item.classList.add("opacity-50");
  });

  item.addEventListener("dragend", () => {
    item.classList.remove("opacity-50");
  });

  item.addEventListener("dragover", e => {
    e.preventDefault();
    const rect = item.getBoundingClientRect();
    const midpoint = rect.top + rect.height / 2;

    if (e.clientY > midpoint) {
      item.after(dragging);
    } else {
      item.before(dragging);
    }
  });
});

document.querySelector("form").addEventListener("submit", () => {
  const order = [];
  document.querySelectorAll("#song-list li").forEach(li => {
    order.push(li.dataset.id);
  });
  document.getElementById("sorted_order").value = order.join(",");
});
</script>
{% endblock %}
