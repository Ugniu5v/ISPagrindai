{% extends "_base.html" %}
{% block title %}{{ koncertas.pavadinimas }} • Muzikos sistema{% endblock %}

{% block content %}
  <!-- Concert Header -->
  <div class="card shadow-sm mb-4 bg-body-tertiary">
    <div class="card-body">
      <div class="d-flex align-items-center justify-content-between">
        <div class="flex-grow-1">
          <h2 class="mb-2 text-body-emphasis">{{ koncertas.pavadinimas }}</h2>
          <p class="text-muted mb-0">
            {% if koncertas.pradzios_data %}{{ koncertas.pradzios_data|date:"Y M d" }}{% endif %} - {% if koncertas.pabaigos_data %}{{ koncertas.pabaigos_data|date:"d" }}{% endif %} · {{ koncertas.get_zanras_display }}
          </p>
        </div>
        {% if "user" in request.session and user and koncertas.autorius.id == user.id %}
          <a href="{% url 'concerts:editConcert' pk=koncertas.pk %}" class="btn btn-outline-light me-2">
            Redaguoti koncertą
          </a>
        {% endif %}
      </div>
    </div>
  </div>

  <div class="row g-4">
    <div class="col-md-8">
      <div class="card shadow-sm mb-4 bg-body-tertiary">
        <div class="card-body">
          <h5 class="card-title mb-4">Koncerto informacija</h5>

          <div class="row mb-3">
            <div class="col-md-6">
              <strong>Pradžios data:</strong><br />
              <span class="text-muted">{% if koncertas.pradzios_data %}{{ koncertas.pradzios_data|date:"Y M d" }}{% else %}Nenurodyta{% endif %}</span>
            </div>
            <div class="col-md-6">
              <strong>Pabaigos data:</strong><br />
              <span class="text-muted">{% if koncertas.pabaigos_data %}{{ koncertas.pabaigos_data|date:"Y M d" }}{% else %}Nenurodyta{% endif %}</span>
            </div>
          </div>

          <div class="row mb-3">
            <div class="col-md-6">
              <strong>Žanras:</strong><br />
              <span class="text-muted">{{ koncertas.get_zanras_display }}</span>
            </div>
            <div class="col-md-6">
              <strong>Bilietų kiekis:</strong><br />
              <span class="text-muted">{{ koncertas.zmoniu_talpa }} bilietų</span>
            </div>
          </div>

          <div class="row mb-3">
            <div class="col-md-6">
              <strong>Rekomendacijos įvertis:</strong><br />
              <span class="text-success">{{ koncertas.rekomendacijos_ivertis|floatformat:1 }}/10</span>
            </div>
            {% if koncertas.bilietu_url %}
            <div class="col-md-6">
              <strong>Bilietų nuoroda:</strong><br />
              <a href="{{ koncertas.bilietu_url }}" target="_blank" class="text-primary">
                {{ koncertas.bilietu_url }}
              </a>
            </div>
            {% endif %}
          </div>

          {% if koncertas.aprasymas %}
          <div class="mb-3">
            <strong>Aprašymas:</strong><br />
            <span class="text-muted">{{ koncertas.aprasymas }}</span>
          </div>
          {% endif %}

          <hr class="my-3" />

          <div class="row">
            <div class="col-md-6">
              <strong>Sukurta:</strong><br />
              <span class="text-muted">{% if koncertas.sukurimo_data %}{{ koncertas.sukurimo_data|date:"Y M d" }}{% else %}Nenurodyta{% endif %}</span>
            </div>
            <div class="col-md-6">
              <strong>Paskutinį kartą atnaujinta:</strong><br />
              <span class="text-muted">{% if koncertas.atnaujinimo_data %}{{ koncertas.atnaujinimo_data|date:"Y M d" }}{% else %}Nenurodyta{% endif %}</span>
            </div>
          </div>

          {% if location %}
            <hr class="my-3" />
            {{ location|json_script:"location-data" }}
            <div>
              <strong>Vieta:</strong><br />
              <div id="map" class="mt-2 rounded" style="height: 400px; width: 100%;"></div>
            </div>
            <link
              rel="stylesheet"
              href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
            />
            <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
            <script>
              window.addEventListener('load', function () {
                const locationDataEl = document.getElementById('location-data');
                const locationData = locationDataEl ? JSON.parse(locationDataEl.textContent) : null;
                const lat = locationData?.lat;
                const lng = locationData?.lng;
                const name = locationData?.name;

                const map = L.map('map').setView([lat, lng], 13);

                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                  maxZoom: 19,
                  attribution: '© OpenStreetMap contributors',
                }).addTo(map);

                L.marker([lat, lng]).addTo(map).bindPopup(name).openPopup();
              });
            </script>
          {% else %}
            <hr class="my-3" />
            <div>
              <strong>Vieta:</strong><br />
              <span class="text-muted">Vietos duomenys neprieinami</span>
            </div>
          {% endif %}
        </div>
      </div>
    </div>

    <div class="col-md-4">
      {% if "user" in request.session %}
      <div class="card shadow-sm mb-4 bg-body-tertiary">
        <div class="card-body">
          <h5 class="card-title mb-3">Dalyvavimo būsena</h5>
          <form method="post" action="#">
            {% csrf_token %}
            <select class="form-select mb-3" name="dalyvavimo_busena">
              <option value="domina" {% if dalyvavimo_busena == 'domina' %}selected{% endif %}>Domina</option>
              <option value="nedalyvauja" {% if not dalyvavimo_busena %}selected{% endif %}>Nedalyvauja</option>
              <option value="dalyvauja" {% if dalyvavimo_busena == 'dalyvauja' %}selected{% endif %}>Dalyvauja</option>
            </select>
            <button type="submit" class="btn btn-primary w-100">Atnaujinti būseną</button>
          </form>
        </div>
      </div>
      {% endif %}
    </div>
  </div>
{% endblock %}
